---
title: "Agreement"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(rvest)
library(dplyr)
library(stringr)
library(knitr)
library(purrr)
```

# Agreement procedure

In order to control the quality of the data we collect and test whether the X-PHI TQRI is reliable, we coded 5% of the total planned sample in pairs. In the preregistration, we aimed to achieve an average agreement rate of 70% between coders. Below is the relevant excerpt from the preregistration:


> Before the main coding phase, we will conduct a preliminary study in which a random 5% of the sample is coded independently by two coders. We expect a high agreement rate (i.e., >70%), measured as raw percentage agreement. If this level is not achieved, we will modify the coder instructions to improve clarity. After each revision, we will recode an additional five papers to check whether the changes have improved inter-coder agreement. Once the target inter-coder agreement is reached, the portion of the sample used in the preliminary study that not meet the expected agreement rate will be recoded by a separate set of coders. The modified codebook will then be uploaded to the project repository. If the target agreement rate is achieved during the first iteration of the preliminary study, data from each pair of coders will be included in the final analysis after discrepancies are discussed and resolved through group discussion.


Here, we analyze the data by extracting the relevant numbers from the HTML reports in the reports directory. Each report was generated by the metacoder tool using exported data from the data directory. Detailed reports also provide information on who coded each article and where the disagreements occurred for each coded article. Below, we present summarized data. The majority of the papers coded in pairs (16 out of 21) achieved the planned agreement level, and the average was over 70%. The relatively large number of disagreements for the two papers at the bottom of the list (`Tanyi2014-TANHTG` and `Pfeifer2009-PFEFHI`) arose from a difference in how the study type was classified (questionnaire vs. non-questionnaire vs. mixed).

All disagreements were resolved during group discussion, and several items and instructions for coders in the X-PHI TQRI were slightly rephrased. The new version that will be used for final coding can be found in the `XPHITQRI.yaml` file and can be easily compared to the initial version.

## Table for All Papers Coded

```{r}
files <- list.files("reports", pattern = "\\.html$", full.names = TRUE)
extract_stats <- function(file) {
  doc <- read_html(file)
  
  total_processed <- doc %>%
    html_node(xpath = "//p[strong[contains(text(),'Total columns processed')]]") %>%
    html_text(trim = TRUE)
  
  agreements <- doc %>%
    html_node(xpath = "//p[strong[contains(text(),'Agreements')]]") %>%
    html_text(trim = TRUE)
  
  disagreements <- doc %>%
    html_node(xpath = "//p[strong[contains(text(),'Disagreements')]]") %>%
    html_text(trim = TRUE)
  
  percentage_agreement <- doc %>%
    html_node(xpath = "//p[strong[contains(text(),'Percentage agreement')]]") %>%
    html_text(trim = TRUE)
  
  
  total_processed_num <-
    str_extract(total_processed, "\\d+\\.?\\d*") %>% as.numeric()
  agreements_num <-
    str_extract(agreements, "\\d+\\.?\\d*") %>% as.numeric()
  disagreements_num  <-
    str_extract(disagreements, "\\d+\\.?\\d*") %>% as.numeric()
  percentage_agreement_num <-
    str_extract(percentage_agreement, "\\d+\\.?\\d*") %>% as.numeric()
  
  tibble(
    `BibTeX` = tools::file_path_sans_ext(basename(file)),
    `Total columns processed` = total_processed_num,
    `Number of agreements` = agreements_num,
    `Number of disagreements` = disagreements_num,
    `Percentage agreement` = percentage_agreement_num,
  )
}

stats_df <- files %>%
  map_dfr(extract_stats)

stats_df <- stats_df %>%
  arrange(desc(`Percentage agreement`))


flextable::flextable(stats_df) %>% flextable::theme_vanilla() %>% flextable::fit_to_width(11.5)

```

# Statistics concerning `Percentage agreement`

```{r}
pct_summary <- stats_df %>%
  summarize(
    Minimum = min(`Percentage agreement`, na.rm = TRUE),
    Maximum = max(`Percentage agreement`, na.rm = TRUE),
    Mean = mean(`Percentage agreement`, na.rm = TRUE),
    Median = median(`Percentage agreement`, na.rm = TRUE),
    `Standard Deviation` = sd(`Percentage agreement`, na.rm = TRUE)
  )
flextable::flextable(pct_summary) %>% flextable::theme_vanilla() %>% flextable::fit_to_width(11.5)
```


